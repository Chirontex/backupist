# Архитектура приложения

## Функциональные требования

1. **Копирование файлов и директорий** из одного места файловой системы в другое (внешний носитель или облачное хранилище)
2. **Работа по расписанию и ручной запуск** - поддержка автоматического и ручного режимов
3. **Множественные интерфейсы**: графический десктопный, веб-интерфейс и консольный интерфейс

## Технические требования

- **Язык разработки**: Go 1.24
- **База данных**: SQLite для хранения настроек
- **Frontend**: React для веб-интерфейса и GUI
- **Desktop**: Electron для графического интерфейса

## Архитектурные принципы

### Hexagonal Architecture (Порты и Адаптеры)

Приложение построено на основе гексагональной архитектуры:

- **Core Domain** - центральная бизнес-логика (backup, storage, scheduler, config)
- **Ports** - интерфейсы для взаимодействия с внешним миром
- **Adapters** - реализации портов (handlers, repositories)

### Слоистая архитектура

1. **Interface Layer** - CLI, Desktop, Web интерфейсы
2. **API Layer** - REST API, GraphQL, IPC Bridge
3. **Service Layer** - бизнес-логика и сервисы
4. **Repository Layer** - доступ к данным
5. **Storage Layer** - физическое хранение данных

## Структура проекта

```
backup-app/
├── cmd/                          # Точки входа приложений
│   ├── cli/main.go              # CLI приложение
│   ├── desktop/main.go          # Desktop приложение  
│   └── server/main.go           # Web сервер
├── internal/                     # Приватные пакеты
│   ├── core/                    # Основная бизнес-логика
│   │   ├── backup/              # Сервис создания бэкапов
│   │   ├── storage/             # Работа с хранилищами
│   │   ├── scheduler/           # Планировщик задач
│   │   └── config/              # Управление конфигурацией
│   ├── handlers/                # Обработчики интерфейсов
│   │   ├── rest/                # REST API handlers
│   │   ├── cli/                 # CLI command handlers
│   │   └── electron/            # Electron IPC handlers
│   ├── repository/              # Слой доступа к данным
│   │   ├── sqlite/              # SQLite репозиторий
│   │   └── cloud/               # Cloud storage репозитории
│   ├── services/                # Бизнес-сервисы
│   └── interfaces/              # Интерфейсы и контракты
├── pkg/                         # Публичные библиотеки
│   ├── models/                  # Модели данных
│   └── utils/                   # Утилиты
├── web/                         # Веб-интерфейс
│   ├── frontend/                # React фронтенд
│   └── electron/                # Electron приложение
├── api/                         # API определения
├── configs/                     # Конфигурационные файлы
├── scripts/                     # Скрипты сборки
├── docs/                        # Документация
└── test/                        # Тесты
```

## Основные компоненты

### 1. BackupService
Центральный сервис для управления процессом создания бэкапов:
- Создание и управление backup задачами
- Координация с FileWalker для обхода файловой системы
- Взаимодействие с StorageService для сохранения данных

### 2. StorageService
Управление хранением данных:
- Абстракция над различными типами хранилищ
- Сжатие и шифрование данных
- Поддержка S3, Google Cloud Storage, Azure Blob Storage

### 3. SchedulerService
Планирование и выполнение задач:
- Поддержка cron выражений
- Ежедневное, еженедельное, ежемесячное расписание
- Интеграция с gocron библиотекой

### 4. ConfigManager
Управление конфигурацией приложения:
- Загрузка и сохранение настроек
- Валидация конфигурации
- Поддержка различных форматов (YAML, JSON)

## Интерфейсы приложения

### CLI интерфейс
- **Технологии**: Go + Cobra CLI
- **Целевая аудитория**: Системные администраторы, DevOps
- **Особенности**: 
  - Автоматизация и скрипты
  - Минимальное потребление ресурсов
  - Идеально для серверного использования

### Desktop интерфейс
- **Технологии**: Electron + React + TypeScript
- **Целевая аудитория**: Обычные пользователи, корпоративные клиенты
- **Особенности**:
  - Нативный вид и поведение
  - Системные уведомления
  - Офлайн работа

### Web интерфейс
- **Технологии**: Go (Gin) + React + TypeScript
- **Целевая аудитория**: Все пользователи, удаленная работа
- **Особенности**:
  - Универсальный доступ
  - Не требует установки
  - Центральное управление

## Хранение данных

### SQLite база данных
Используется для хранения:
- Политик создания бэкапов
- Метаданных о выполненных задачах
- Конфигурации приложения
- История операций

### Облачные хранилища
Поддерживаемые провайдеры:
- Amazon S3
- Google Cloud Storage
- Azure Blob Storage
- Локальная файловая система

## Безопасность

### Шифрование
- **Алгоритм**: AES-256-GCM
- **Ключи**: Управляемые пользователем
- **Область**: Данные в покое и при передаче

### Сжатие
- **Алгоритмы**: gzip, zstd
- **Применение**: Перед шифрованием
- **Настройка**: Уровень сжатия настраивается

## Планирование задач

### Типы расписаний
- **Manual** - ручной запуск
- **Daily** - ежедневное выполнение
- **Weekly** - еженедельное выполнение  
- **Monthly** - ежемесячное выполнение
- **Cron** - произвольное cron выражение

### Библиотека планировщика
- **gocron** - основная библиотека
- **robfig/cron** - альтернатива для сложных случаев

## Модели данных

### BackupJob
Представляет задачу создания бэкапа:
```go
type BackupJob struct {
    ID             string
    Status         JobStatus
    SourcePath     string
    TargetStorage  string
    TotalFiles     int64
    ProcessedFiles int64
    CreatedAt      time.Time
}
```

### BackupPolicy
Политика создания бэкапов:
```go
type BackupPolicy struct {
    ID                  string
    Name                string
    SourcePath          string
    TargetStorage       string
    ScheduleType        ScheduleType
    ScheduleTime        time.Time
    IncludePatterns     []string
    ExcludePatterns     []string
    EncryptionEnabled   bool
    CompressionEnabled  bool
}
```

## API дизайн

### REST API endpoints
```
POST /api/v1/backups          # Создать backup
GET  /api/v1/backups          # Список backups
GET  /api/v1/backups/:id      # Детали backup
DELETE /api/v1/backups/:id    # Удалить backup
POST /api/v1/backups/:id/restore # Восстановить

GET  /api/v1/jobs/:id         # Статус задачи
GET  /api/v1/policies         # Политики backup
POST /api/v1/policies         # Создать политику
```

### GraphQL API
Альтернативный API для сложных запросов и real-time обновлений.

## Развертывание

### Docker контейнеры
- **Backend**: Go приложение
- **Frontend**: Nginx + React статика
- **Database**: SQLite файл в volume

### Kubernetes
Поддержка развертывания в Kubernetes с:
- ConfigMaps для конфигурации
- Secrets для ключей шифрования
- PersistentVolumes для данных

## Мониторинг и логирование

### Логирование
- **Библиотека**: logrus или zap
- **Уровни**: DEBUG, INFO, WARN, ERROR
- **Формат**: JSON для структурированности

### Метрики
- Количество выполненных backup'ов
- Время выполнения операций
- Размер обработанных данных
- Статус задач

## Тестирование

### Unit тесты
- **Библиотека**: testify
- **Покрытие**: минимум 80%
- **Моки**: gomock для интерфейсов

### Integration тесты
- Тестирование API endpoints
- Тестирование взаимодействия с базой данных
- E2E тесты для основных сценариев

## Масштабирование

### Горизонтальное масштабирование
- Stateless backend сервисы
- Распределенная обработка больших файлов
- Queue-based архитектура для задач

### Производительность
- Goroutines для параллельной обработки
- Connection pooling для базы данных
- Кэширование метаданных

## Рекомендации по развитию

1. **Добавление новых storage providers** через интерфейс StorageProvider
2. **Расширение типов расписаний** в SchedulerService
3. **Интеграция с системами мониторинга** (Prometheus, Grafana)
4. **Добавление webhook'ов** для уведомлений
5. **Поддержка инкрементальных backup'ов** по аналогии с Kopia
6. **Дедупликация данных** на уровне блоков